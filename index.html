<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Vendas - Farmácia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { 
            background-color: #f8f9fa; 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; 
            font-size: 14px;
        }
        #loginScreen { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            z-index: 9999; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            padding: 15px;
        }
        #loginBox { 
            background: white; 
            padding: 2rem; 
            border-radius: 15px; 
            box-shadow: 0 15px 40px rgba(0,0,0,0.5); 
            width: 100%; 
            max-width: 450px; 
        }
        #app { display: none; }
        .sidebar { 
            min-height: 100vh; 
            background-color: #ffffff; 
            padding: 15px; 
            box-shadow: 2px 0 5px rgba(0,0,0,0.1); 
            position: fixed;
            z-index: 100;
            overflow-y: auto;
        }
        .sidebar .nav-link { 
            color: #0d6efd; 
            padding: 10px; 
            display: flex; 
            align-items: center; 
            font-size: 0.9rem; 
            border-radius: 5px;
            margin-bottom: 5px;
        }
        .sidebar .nav-link.active { 
            background-color: #0d6efd; 
            color: white !important; 
        }
        .sidebar .nav-link i { 
            margin-right: 8px; 
            font-size: 1rem;
        }
        .table th { 
            background-color: #0d6efd; 
            color: white; 
            font-size: 0.8rem; 
            padding: 0.5rem;
        }
        .table td { 
            font-size: 0.85rem; 
            padding: 0.5rem; 
            vertical-align: middle; 
        }
        .below-meta { background-color: #f8d7da !important; color: #721c24; }
        .above-meta { background-color: #d1e7dd !important; color: #155724; }
        .card { 
            border-radius: 10px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); 
            margin-bottom: 15px;
        }
        .chart-container { 
            width: 100%; 
            margin: 15px auto; 
            height: 300px; 
            position: relative;
        }
        .btn-custom { 
            background-color: #0d6efd; 
            color: white; 
            font-size: 0.9rem;
        }
        .btn-custom:hover { background-color: #0a58ca; }
        .action-btns .btn { 
            width: 32px; 
            height: 32px; 
            padding: 0; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 0.9rem; 
            margin: 0 2px;
        }
        .form-row { 
            display: flex; 
            flex-wrap: wrap; 
            gap: 0.5rem; 
            align-items: end; 
        }
        .form-row > div { 
            flex: 1 1 120px; 
            min-width: 0;
        }
        .form-row .col-clientes { flex: 0 0 90px; }
        .table-responsive { 
            overflow-x: auto; 
            -webkit-overflow-scrolling: touch;
        }
        .table td, .table th { 
            white-space: nowrap; 
        }
        .hidden { display: none; }
        .meta-ok { background-color: #d4edda !important; color: #155724; }
        .meta-no { background-color: #f8d7da !important; color: #721c24; }
        
        /* Responsividade melhorada */
        @media (max-width: 768px) {
            .sidebar { 
                position: fixed; 
                top: 0; 
                left: -280px; 
                width: 280px; 
                transition: 0.3s; 
                z-index: 1000; 
            }
            .sidebar.active { left: 0; }
            .content { 
                margin-left: 0; 
                width: 100%;
            }
            .form-row { 
                flex-direction: column; 
            }
            .form-row > div {
                flex: 1 1 100%;
                width: 100%;
            }
            .form-row .col-clientes {
                flex: 1 1 100%;
            }
            .table th, .table td {
                padding: 0.4rem;
                font-size: 0.75rem;
            }
            .chart-container {
                height: 250px;
            }
            .card-body {
                padding: 1rem;
            }
            h1 {
                font-size: 1.5rem;
            }
            .modal-dialog {
                margin: 10px;
            }
            .modal-content {
                padding: 10px;
            }
        }
        
        @media (max-width: 576px) {
            body {
                font-size: 13px;
            }
            #loginBox {
                padding: 1.5rem;
            }
            .sidebar {
                width: 250px;
                left: -250px;
            }
            .table th, .table td {
                padding: 0.3rem;
                font-size: 0.7rem;
            }
            .action-btns .btn {
                width: 28px;
                height: 28px;
                font-size: 0.8rem;
            }
            .chart-container {
                height: 200px;
            }
            .btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
        
        .toggle-btn { 
            display: none; 
            background-color: #0d6efd; 
            color: white; 
            border: none; 
            padding: 10px; 
            border-radius: 5px; 
            position: fixed;
            top: 10px;
            left: 10px;
            z-index: 101;
        }
        
        .overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 99;
        }
        
        .overlay.active {
            display: block;
        }
        
        /* Ajustes para telas muito pequenas */
        @media (max-width: 360px) {
            .container-fluid {
                padding-left: 5px;
                padding-right: 5px;
            }
            .table-responsive {
                font-size: 0.7rem;
            }
        }
        
        /* Melhorias para formulários em mobile */
        .form-control, .form-select {
            font-size: 0.9rem;
        }
        
        @media (max-width: 768px) {
            .form-control, .form-select {
                font-size: 16px; /* Previne zoom no iOS */
            }
        }

        /* Botão de relatório */
        .btn-relatorio {
            background-color: #28a745;
            color: white;
        }
        .btn-relatorio:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>

    <!-- TELA DE LOGIN -->
    <div id="loginScreen">
        <div id="loginBox">
            <h3 class="text-center mb-4 text-primary">Login - Farmácia</h3>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Usuário</label>
                    <input type="text" class="form-control" id="username" required autofocus>
                </div>
                <div class="mb-3">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-custom w-100">Entrar</button>
            </form>
            <div class="text-center mt-3">
                <small class="text-muted">admin / admin123</small>
            </div>
        </div>
    </div>

    <!-- APLICATIVO -->
    <div id="app" class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <button class="toggle-btn" onclick="toggleSidebar()">
                <i class="bi bi-filter-left"></i>
            </button>
            <div class="overlay" onclick="toggleSidebar()"></div>
            
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar">
                <h5 class="text-center mb-4">Filtros</h5>
                <div class="list-group">
                    <label class="list-group-item">Lojas</label>
                    <div id="lojasFiltros"></div>
                    <label class="list-group-item">Período</label>
                    <select class="form-select mb-3" id="filtroPeriodo" onchange="atualizarCampoData()">
                        <option value="todos">Todos</option>
                        <option value="dia">Por Dia</option>
                        <option value="mes">Por Mês</option>
                    </select>
                    <div id="filtroDataDiv" style="display:none;">
                        <label class="list-group-item">Data</label>
                        <input type="date" class="form-control mb-3" id="filtroData">
                    </div>
                    <button class="btn btn-custom w-100" onclick="aplicarFiltro()">Aplicar Filtro</button>

                    <!-- ADMINISTRAÇÃO -->
                    <div id="adminMenu" class="mt-4" style="display:none;">
                        <label class="list-group-item">Administração</label>
                        <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#metasModal">
                            <i class="bi bi-gear"></i> Calibragem de Metas
                        </a>
                        <a href="#" class="nav-link" id="linkTelaMetas" data-bs-toggle="modal" data-bs-target="#telaMetasModal">
                            <i class="bi bi-graph-up"></i> Tela de Metas
                        </a>
                        <a href="#" class="nav-link" onclick="abrirHistoricoMetas()">
                            <i class="bi bi-clock-history"></i> Histórico de Metas
                        </a>
                        <a href="#" class="nav-link" onclick="abrirRelatorioVendas()">
                            <i class="bi bi-file-earmark-excel"></i> Relatório de Vendas
                        </a>
                        <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#userListModal">
                            <i class="bi bi-people"></i> Gerenciar Usuários
                        </a>
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="col-md-9 col-lg-10 content ms-auto">
                <div class="container-fluid mt-3">
                    <h1 class="text-center mb-3 text-primary">Gestão de Vendas - Farmácia</h1>
                    <p class="text-center text-muted">Atualizado em <span id="currentDate"></span></p>
                    <div id="userInfo" class="text-end mb-3"></div>

                    <!-- CRUD -->
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header p-2">
                                    <ul class="nav nav-tabs card-header-tabs">
                                        <li class="nav-item">
                                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#add">Adicionar</button>
                                        </li>
                                        <li class="nav-item">
                                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#edit">Editar</button>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body p-2">
                                    <div class="tab-content">
                                        <!-- Adicionar -->
                                        <div class="tab-pane fade show active" id="add">
                                            <form id="addForm" class="form-row">
                                                <div>
                                                    <label class="form-label small">Loja</label>
                                                    <select class="form-select form-select-sm" id="addLoja"></select>
                                                </div>
                                                <div>
                                                    <label class="form-label small">Data</label>
                                                    <input type="date" class="form-control form-control-sm" id="addData" required>
                                                </div>
                                                <div>
                                                    <label class="form-label small">Dia da Semana</label>
                                                    <select class="form-select form-select-sm" id="addDiaSemana"></select>
                                                </div>
                                                <div>
                                                    <label class="form-label small">Real. Bruta</label>
                                                    <input type="number" step="0.01" class="form-control form-control-sm" id="addRealizadoBruta" required>
                                                </div>
                                                <div>
                                                    <label class="form-label small">Real. Líquida</label>
                                                    <input type="number" step="0.01" class="form-control form-control-sm" id="addRealizadoLiquida" required>
                                                </div>
                                                <div class="col-clientes">
                                                    <label class="form-label small">Clientes</label>
                                                    <input type="number" class="form-control form-control-sm" id="addClientes" required>
                                                </div>
                                                <div class="align-self-end">
                                                    <button type="submit" class="btn btn-custom btn-sm">Adicionar</button>
                                                </div>
                                            </form>
                                        </div>
                                        <!-- Editar -->
                                        <div class="tab-pane fade" id="edit">
                                            <form id="editForm" class="form-row" style="display:none;">
                                                <input type="hidden" id="editId">
                                                <div>
                                                    <label class="form-label small">Loja</label>
                                                    <select class="form-select form-select-sm" id="editLoja"></select>
                                                </div>
                                                <div>
                                                    <label class="form-label small">Data</label>
                                                    <input type="date" class="form-control form-control-sm" id="editData">
                                                </div>
                                                <div>
                                                    <label class="form-label small">Dia da Semana</label>
                                                    <select class="form-select form-select-sm" id="editDiaSemana"></select>
                                                </div>
                                                <div>
                                                    <label class="form-label small">Real. Bruta</label>
                                                    <input type="number" step="0.01" class="form-control form-control-sm" id="editRealizadoBruta">
                                                </div>
                                                <div>
                                                    <label class="form-label small">Real. Líquida</label>
                                                    <input type="number" step="0.01" class="form-control form-control-sm" id="editRealizadoLiquida">
                                                </div>
                                                <div class="col-clientes">
                                                    <label class="form-label small">Clientes</label>
                                                    <input type="number" class="form-control form-control-sm" id="editClientes">
                                                </div>
                                                <div class="align-self-end">
                                                    <button type="submit" class="btn btn-custom btn-sm">Salvar</button>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela Principal -->
                    <div class="table-responsive">
                        <div id="tabelaContainer"></div>
                    </div>
                    <div class="chart-container">
                        <canvas id="vendasChart"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL RELATÓRIO DE VENDAS -->
    <div class="modal fade" id="relatorioVendasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Relatório Completo de Vendas</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">Data Início</label>
                            <input type="date" class="form-control" id="relatorioDataInicio">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Data Fim</label>
                            <input type="date" class="form-control" id="relatorioDataFim">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Loja</label>
                            <select class="form-select" id="relatorioLoja">
                                <option value="TODAS">Todas as Lojas</option>
                                <option>Loja A</option>
                                <option>Loja B</option>
                                <option>Loja C</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12">
                            <button class="btn btn-relatorio me-2" onclick="gerarRelatorio()">
                                <i class="bi bi-search"></i> Gerar Relatório
                            </button>
                            <button class="btn btn-success" onclick="exportarParaExcel()" id="btnExportarExcel" disabled>
                                <i class="bi bi-file-earmark-excel"></i> Exportar para Excel
                            </button>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-primary">
                                <tr>
                                    <th>ID</th>
                                    <th>Loja</th>
                                    <th>Data Venda</th>
                                    <th>Dia Semana</th>
                                    <th>Realizado Bruta</th>
                                    <th>Realizado Líquida</th>
                                    <th>Clientes</th>
                                    <th>Ticket Médio</th>
                                    <th>Meta Bruta</th>
                                    <th>Meta Líquida</th>
                                    <th>Dif. Bruta</th>
                                    <th>Dif. Líquida</th>
                                    <th>Usuário</th>
                                    <th>Data/Hora Lançamento</th>
                                </tr>
                            </thead>
                            <tbody id="relatorioVendasBody"></tbody>
                        </table>
                    </div>
                    
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <h6 class="mb-0">Resumo do Relatório</h6>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>Total Bruto:</strong> 
                                            <span id="resumoTotalBruto" class="text-success">R$ 0,00</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Total Líquido:</strong> 
                                            <span id="resumoTotalLiquido" class="text-success">R$ 0,00</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Total Clientes:</strong> 
                                            <span id="resumoTotalClientes">0</span>
                                        </div>
                                        <div class="col-md-3">
                                            <strong>Ticket Médio:</strong> 
                                            <span id="resumoTicketMedio" class="text-info">R$ 0,00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAIS EXISTENTES (metas, histórico, usuários) -->
    <!-- MODAL CALIBRAGEM -->
    <div class="modal fade" id="metasModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Conteúdo existente do modal de metas -->
            </div>
        </div>
    </div>

    <!-- MODAL HISTÓRICO DE METAS -->
    <div class="modal fade" id="historicoMetasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Conteúdo existente do modal de histórico -->
            </div>
        </div>
    </div>

    <!-- TELA DE METAS -->
    <div class="modal fade" id="telaMetasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <!-- Conteúdo existente -->
            </div>
        </div>
    </div>

    <!-- MODAL LISTA DE USUÁRIOS -->
    <div class="modal fade" id="userListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <!-- Conteúdo existente -->
            </div>
        </div>
    </div>

    <!-- MODAL CADASTRO USUÁRIO -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <!-- Conteúdo existente -->
            </div>
        </div>
    </div>

    <script>
        // VARIÁVEIS GLOBAIS
        let dados = JSON.parse(localStorage.getItem('dados')) || [];
        let metasMes = JSON.parse(localStorage.getItem('metasMes')) || [];
        let historicoMetas = JSON.parse(localStorage.getItem('historicoMetas')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [{username: 'admin', password: 'admin123', role: 'ceo'}];
        let currentUser = null;
        let nextId = dados.length > 0 ? Math.max(...dados.map(d => d.id)) + 1 : 0;
        const todasLojas = ['Loja A', 'Loja B', 'Loja C'];
        let dadosRelatorio = [];

        // FUNÇÃO PARA ABRIR RELATÓRIO DE VENDAS
        function abrirRelatorioVendas() {
            // Configurar datas padrão (últimos 30 dias)
            const dataFim = new Date();
            const dataInicio = new Date();
            dataInicio.setDate(dataInicio.getDate() - 30);
            
            document.getElementById('relatorioDataInicio').value = dataInicio.toISOString().split('T')[0];
            document.getElementById('relatorioDataFim').value = dataFim.toISOString().split('T')[0];
            
            new bootstrap.Modal(document.getElementById('relatorioVendasModal')).show();
        }

        // FUNÇÃO PARA GERAR RELATÓRIO
        function gerarRelatorio() {
            const dataInicio = document.getElementById('relatorioDataInicio').value;
            const dataFim = document.getElementById('relatorioDataFim').value;
            const lojaSelecionada = document.getElementById('relatorioLoja').value;

            if (!dataInicio || !dataFim) {
                alert('Por favor, selecione as datas de início e fim.');
                return;
            }

            // Filtrar dados
            dadosRelatorio = dados.filter(venda => {
                const dataVenda = new Date(venda.data);
                const inicio = new Date(dataInicio);
                const fim = new Date(dataFim);
                fim.setDate(fim.getDate() + 1); // Incluir o dia final

                // Filtro de data
                if (dataVenda < inicio || dataVenda >= fim) return false;

                // Filtro de loja
                if (lojaSelecionada !== 'TODAS' && venda.loja !== lojaSelecionada) return false;

                return true;
            });

            // Ordenar por data mais recente primeiro
            dadosRelatorio.sort((a, b) => new Date(b.data) - new Date(a.data));

            renderRelatorioVendas();
            calcularResumoRelatorio();
            
            // Habilitar botão de exportação
            document.getElementById('btnExportarExcel').disabled = false;
        }

        // FUNÇÃO PARA RENDERIZAR RELATÓRIO NA TABELA
        function renderRelatorioVendas() {
            const tbody = document.getElementById('relatorioVendasBody');
            tbody.innerHTML = '';

            if (dadosRelatorio.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="text-center">Nenhum dado encontrado para o período selecionado.</td></tr>';
                return;
            }

            dadosRelatorio.forEach(venda => {
                const tr = document.createElement('tr');
                
                // Buscar meta do mês
                const mesVenda = venda.data.slice(0, 7);
                const meta = metasMes.find(m => m.mes === mesVenda && (m.loja === venda.loja || m.loja === 'TODAS'));
                
                const metaBruta = meta ? meta.metaBruta : 0;
                const metaLiquida = meta ? meta.metaLiquida : 0;
                const diferencaBruta = venda.realizadoBruta - metaBruta;
                const diferencaLiquida = venda.realizadoLiquida - metaLiquida;
                const ticketMedio = venda.clientes > 0 ? venda.realizadoBruta / venda.clientes : 0;

                tr.innerHTML = `
                    <td>${venda.id}</td>
                    <td>${venda.loja}</td>
                    <td>${venda.data}</td>
                    <td>${venda.diaSemana}</td>
                    <td>R$ ${venda.realizadoBruta.toFixed(2)}</td>
                    <td>R$ ${venda.realizadoLiquida.toFixed(2)}</td>
                    <td>${venda.clientes}</td>
                    <td>R$ ${ticketMedio.toFixed(2)}</td>
                    <td>R$ ${metaBruta.toFixed(2)}</td>
                    <td>R$ ${metaLiquida.toFixed(2)}</td>
                    <td class="${diferencaBruta >= 0 ? 'text-success' : 'text-danger'}">
                        R$ ${diferencaBruta.toFixed(2)}
                    </td>
                    <td class="${diferencaLiquida >= 0 ? 'text-success' : 'text-danger'}">
                        R$ ${diferencaLiquida.toFixed(2)}
                    </td>
                    <td>${venda.addedBy || 'N/A'}</td>
                    <td>${venda.dataHoraLancamento || 'N/A'}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // FUNÇÃO PARA CALCULAR RESUMO DO RELATÓRIO
        function calcularResumoRelatorio() {
            if (dadosRelatorio.length === 0) {
                document.getElementById('resumoTotalBruto').textContent = 'R$ 0,00';
                document.getElementById('resumoTotalLiquido').textContent = 'R$ 0,00';
                document.getElementById('resumoTotalClientes').textContent = '0';
                document.getElementById('resumoTicketMedio').textContent = 'R$ 0,00';
                return;
            }

            const totalBruto = dadosRelatorio.reduce((sum, venda) => sum + venda.realizadoBruta, 0);
            const totalLiquido = dadosRelatorio.reduce((sum, venda) => sum + venda.realizadoLiquida, 0);
            const totalClientes = dadosRelatorio.reduce((sum, venda) => sum + venda.clientes, 0);
            const ticketMedio = totalClientes > 0 ? totalBruto / totalClientes : 0;

            document.getElementById('resumoTotalBruto').textContent = `R$ ${totalBruto.toFixed(2)}`;
            document.getElementById('resumoTotalLiquido').textContent = `R$ ${totalLiquido.toFixed(2)}`;
            document.getElementById('resumoTotalClientes').textContent = totalClientes.toLocaleString();
            document.getElementById('resumoTicketMedio').textContent = `R$ ${ticketMedio.toFixed(2)}`;
        }

        // FUNÇÃO PARA EXPORTAR PARA EXCEL
        function exportarParaExcel() {
            if (dadosRelatorio.length === 0) {
                alert('Não há dados para exportar. Gere um relatório primeiro.');
                return;
            }

            try {
                // Preparar dados para Excel
                const dadosExcel = dadosRelatorio.map(venda => {
                    const mesVenda = venda.data.slice(0, 7);
                    const meta = metasMes.find(m => m.mes === mesVenda && (m.loja === venda.loja || m.loja === 'TODAS'));
                    
                    const metaBruta = meta ? meta.metaBruta : 0;
                    const metaLiquida = meta ? meta.metaLiquida : 0;
                    const diferencaBruta = venda.realizadoBruta - metaBruta;
                    const diferencaLiquida = venda.realizadoLiquida - metaLiquida;
                    const ticketMedio = venda.clientes > 0 ? venda.realizadoBruta / venda.clientes : 0;

                    return {
                        'ID': venda.id,
                        'Loja': venda.loja,
                        'Data Venda': venda.data,
                        'Dia Semana': venda.diaSemana,
                        'Realizado Bruta (R$)': venda.realizadoBruta,
                        'Realizado Líquida (R$)': venda.realizadoLiquida,
                        'Clientes': venda.clientes,
                        'Ticket Médio (R$)': ticketMedio,
                        'Meta Bruta (R$)': metaBruta,
                        'Meta Líquida (R$)': metaLiquida,
                        'Diferença Bruta (R$)': diferencaBruta,
                        'Diferença Líquida (R$)': diferencaLiquida,
                        'Usuário': venda.addedBy || 'N/A',
                        'Data/Hora Lançamento': venda.dataHoraLancamento || 'N/A'
                    };
                });

                // Criar workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.json_to_sheet(dadosExcel);

                // Adicionar worksheet ao workbook
                XLSX.utils.book_append_sheet(wb, ws, "Relatório de Vendas");

                // Gerar nome do arquivo com data
                const dataAtual = new Date().toISOString().slice(0, 10);
                const nomeArquivo = `relatorio_vendas_${dataAtual}.xlsx`;

                // Salvar arquivo
                XLSX.writeFile(wb, nomeArquivo);

                alert('Relatório exportado com sucesso!');

            } catch (error) {
                console.error('Erro ao exportar para Excel:', error);
                alert('Erro ao exportar para Excel. Verifique o console para mais detalhes.');
            }
        }

        // MODIFICAR A FUNÇÃO DE ADICIONAR VENDA PARA INCLUIR DATA/HORA
        document.getElementById('addForm').addEventListener('submit', e => {
            e.preventDefault();
            const loja = document.getElementById('addLoja').value;
            const data = document.getElementById('addData').value;
            
            const novaVenda = {
                id: nextId++,
                loja, 
                data, 
                diaSemana: getDiaSemana(data),
                realizadoBruta: parseFloat(document.getElementById('addRealizadoBruta').value),
                realizadoLiquida: parseFloat(document.getElementById('addRealizadoLiquida').value),
                clientes: parseInt(document.getElementById('addClientes').value),
                addedBy: currentUser.username,
                dataHoraLancamento: new Date().toLocaleString('pt-BR')
            };
            
            dados.push(novaVenda);
            localStorage.setItem('dados', JSON.stringify(dados));
            aplicarMetasNaTabela();
            alert('Venda adicionada com sucesso!');
            e.target.reset();
            aplicarFiltro();
        });

        // Restante das funções existentes...
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.querySelector('.overlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        document.getElementById('currentDate').textContent = new Date().toLocaleDateString('pt-BR');

        // ... (todas as outras funções existentes permanecem iguais)

        // Inicialização
        preencherDiaSemana();
        mostrarLogin();
        atualizarCampoData();

        // Adicionar evento para Enter no formulário de login
        document.getElementById('loginForm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                document.getElementById('loginForm').dispatchEvent(new Event('submit'));
            }
        });

    </script>
</body>
</html>
