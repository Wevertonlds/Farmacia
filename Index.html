<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestão de Vendas - Farmácia</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; }
        #loginScreen { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.95); z-index: 9999; display: flex; 
            justify-content: center; align-items: center; 
        }
        #loginBox { background: white; padding: 2.5rem; border-radius: 15px; box-shadow: 0 15px 40px rgba(0,0,0,0.5); width: 100%; max-width: 450px; }
        #app { display: none; }
        .sidebar { min-height: 100vh; background-color: #ffffff; padding: 20px; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
        .sidebar .nav-link { color: #0d6efd; padding: 10px; display: flex; align-items: center; font-size: 0.95rem; }
        .sidebar .nav-link.active { background-color: #0d6efd; color: white !important; }
        .sidebar .nav-link i { margin-right: 8px; }
        .table th { background-color: #0d6efd; color: white; font-size: 0.85rem; }
        .table td { font-size: 0.9rem; padding: 0.5rem; vertical-align: middle; }
        .below-meta { background-color: #f8d7da !important; color: #721c24; }
        .above-meta { background-color: #d1e7dd !important; color: #155724; }
        .card { border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .chart-container { max-width: 800px; margin: 20px auto; height: 320px; }
        .btn-custom { background-color: #0d6efd; color: white; }
        .btn-custom:hover { background-color: #0a58ca; }
        .action-btns .btn { 
            width: 36px; height: 36px; padding: 0; 
            display: inline-flex; align-items: center; justify-content: center; 
            font-size: 1.1rem; margin: 0 3px;
        }
        .form-row { display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: end; }
        .form-row > div { flex: 1 1 130px; }
        .form-row .col-clientes { flex: 0 0 110px; }
        .table-responsive { overflow-x: auto; }
        .table td, .table th { white-space: nowrap; }
        .hidden { display: none; }
        .meta-ok { background-color: #d4edda !important; color: #155724; }
        .meta-no { background-color: #f8d7da !important; color: #721c24; }
        @media (max-width: 768px) {
            .sidebar { position: fixed; top: 0; left: -250px; width: 250px; transition: 0.3s; z-index: 1000; }
            .sidebar.active { left: 0; }
            .toggle-btn { display: block; }
            .content { margin-left: 0; }
            .form-row { flex-direction: column; }
        }
        .toggle-btn { display: none; background-color: #0d6efd; color: white; border: none; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

    <!-- TELA DE LOGIN -->
    <div id="loginScreen">
        <div id="loginBox">
            <h3 class="text-center mb-4 text-primary">Login - Farmácia</h3>
            <form id="loginForm">
                <div class="mb-3">
                    <label class="form-label">Usuário</label>
                    <input type="text" class="form-control" id="username" required autofocus>
                </div>
                <div class="mb-3">
                    <label class="form-label">Senha</label>
                    <input type="password" class="form-control" id="password" required>
                </div>
                <button type="submit" class="btn btn-custom w-100">Entrar</button>
            </form>
            <div class="text-center mt-3">
                <small class="text-muted">admin / admin123</small>
            </div>
        </div>
    </div>

    <!-- APLICATIVO -->
    <div id="app" class="container-fluid">
        <div class="row">
            <!-- Sidebar -->
            <nav id="sidebar" class="col-md-3 col-lg-2 d-md-block sidebar">
                <h5 class="text-center mb-4">Filtros</h5>
                <div class="list-group">
                    <label class="list-group-item">Lojas</label>
                    <div id="lojasFiltros"></div>
                    <label class="list-group-item">Período</label>
                    <select class="form-select mb-3" id="filtroPeriodo" onchange="atualizarCampoData()">
                        <option value="todos">Todos</option>
                        <option value="dia">Por Dia</option>
                        <option value="mes">Por Mês</option>
                    </select>
                    <div id="filtroDataDiv" style="display:none;">
                        <label class="list-group-item">Data</label>
                        <input type="date" class="form-control mb-3" id="filtroData">
                    </div>
                    <button class="btn btn-custom w-100" onclick="aplicarFiltro()">Aplicar Filtro</button>

                    <!-- ADMINISTRAÇÃO -->
                    <div id="adminMenu" class="mt-4" style="display:none;">
                        <label class="list-group-item">Administração</label>
                        <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#metasModal">
                            Calibragem de Metas
                        </a>
                        <a href="#" class="nav-link" id="linkTelaMetas" data-bs-toggle="modal" data-bs-target="#telaMetasModal">
                            Tela de Metas
                        </a>
                        <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#userListModal">
                            Gerenciar Usuários
                        </a>
                    </div>
                </div>
            </nav>
            <button class="toggle-btn" onclick="toggleSidebar()">Filtros</button>

            <!-- Main Content -->
            <main class="col-md-9 col-lg-10 content">
                <div class="container mt-4">
                    <h1 class="text-center mb-4 text-primary">Gestão de Vendas - Farmácia</h1>
                    <p class="text-center text-muted">Atualizado em 05/11/2025</p>
                    <div id="userInfo" class="text-end mb-3"></div>

                    <!-- CRUD -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-header">
                                    <ul class="nav nav-tabs card-header-tabs">
                                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#add">Adicionar</button></li>
                                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#edit">Editar</button></li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content">
                                        <!-- Adicionar -->
                                        <div class="tab-pane fade show active" id="add">
                                            <form id="addForm" class="form-row">
                                                <div><label>Loja</label><select class="form-select" id="addLoja"></select></div>
                                                <div><label>Data</label><input type="date" class="form-control" id="addData" required></div>
                                                <div><label>Dia da Semana</label><select class="form-select" id="addDiaSemana"></select></div>
                                                <div><label>Real. Bruta</label><input type="number" step="0.01" class="form-control" id="addRealizadoBruta" required></div>
                                                <div><label>Real. Líquida</label><input type="number" step="0.01" class="form-control" id="addRealizadoLiquida" required></div>
                                                <div class="col-clientes"><label>Clientes</label><input type="number" class="form-control" id="addClientes" required></div>
                                                <div class="align-self-end"><button type="submit" class="btn btn-custom">Adicionar</button></div>
                                            </form>
                                        </div>
                                        <!-- Editar -->
                                        <div class="tab-pane fade" id="edit">
                                            <form id="editForm" class="form-row" style="display:none;">
                                                <input type="hidden" id="editId">
                                                <div><label>Loja</label><select class="form-select" id="editLoja"></select></div>
                                                <div><label>Data</label><input type="date" class="form-control" id="editData"></div>
                                                <div><label>Dia da Semana</label><select class="form-select" id="editDiaSemana"></select></div>
                                                <div><label>Real. Bruta</label><input type="number" step="0.01" class="form-control" id="editRealizadoBruta"></div>
                                                <div><label>Real. Líquida</label><input type="number" step="0.01" class="form-control" id="editRealizadoLiquida"></div>
                                                <div class="col-clientes"><label>Clientes</label><input type="number" class="form-control" id="editClientes"></div>
                                                <div class="align-self-end"><button type="submit" class="btn btn-custom">Salvar</button></div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabela Principal -->
                    <div class="table-responsive">
                        <div id="tabelaContainer"></div>
                    </div>
                    <div class="chart-container">
                        <canvas id="vendasChart"></canvas>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- MODAL CALIBRAGEM -->
    <div class="modal fade" id="metasModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Calibragem de Metas do Mês</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="metasForm" class="row g-3">
                        <div class="col-md-6">
                            <label>Mês</label>
                            <input type="month" class="form-control" id="metaMes" required>
                        </div>
                        <div class="col-md-6">
                            <label>Loja</label>
                            <select class="form-select" id="metaLoja" required>
                                <option value="">Selecione...</option>
                                <option value="TODAS">TODAS AS LOJAS</option>
                                <option>Loja A</option><option>Loja B</option><option>Loja C</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label>Meta Bruta</label>
                            <input type="number" step="0.01" class="form-control" id="metaBruta" required>
                        </div>
                        <div class="col-md-6">
                            <label>Meta Líquida</label>
                            <input type="number" step="0.01" class="form-control" id="metaLiquida" required>
                        </div>
                        <div class="col-md-4">
                            <label>Meta Gerente</label>
                            <input type="number" step="0.01" class="form-control" id="metaGerente">
                        </div>
                        <div class="col-md-4">
                            <label>Meta Diretor</label>
                            <input type="number" step="0.01" class="form-control" id="metaDiretor">
                        </div>
                        <div class="col-md-4">
                            <label>Meta Analista</label>
                            <input type="number" step="0.01" class="form-control" id="metaAnalista">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-custom">Gravar</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- TELA DE METAS -->
    <div class="modal fade" id="telaMetasModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Tela de Metas - Colaboradores</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-sm">
                            <thead class="table-primary">
                                <tr>
                                    <th>Data</th>
                                    <th>Loja</th>
                                    <th>Real Bruta</th>
                                    <th>Meta Bruta</th>
                                    <th>Status</th>
                                    <th>Real Líq.</th>
                                    <th>Meta Líq.</th>
                                    <th>Status</th>
                                    <th>Gerente</th>
                                    <th>Diretor</th>
                                    <th>Analista</th>
                                </tr>
                            </thead>
                            <tbody id="telaMetasBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL LISTA DE USUÁRIOS -->
    <div class="modal fade" id="userListModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gerenciar Usuários</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-success btn-sm mb-3" data-bs-toggle="modal" data-bs-target="#userModal">
                        Novo Usuário
                    </button>
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>Usuário</th>
                                    <th>Hierarquia</th>
                                    <th>Loja(s)</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="userListBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL CADASTRO USUÁRIO -->
    <div class="modal fade" id="userModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Cadastrar Usuário</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="userForm">
                        <div class="mb-3">
                            <label>Usuário</label>
                            <input type="text" class="form-control" id="newUsername" required>
                        </div>
                        <div class="mb-3">
                            <label>Senha</label>
                            <input type="password" class="form-control" id="newPassword" required>
                        </div>
                        <div class="mb-3">
                            <label>Hierarquia</label>
                            <select class="form-select" id="newRole" required>
                                <option value="diretor">Diretor</option>
                                <option value="gerente">Gerente</option>
                                <option value="analista">Analista</option>
                            </select>
                        </div>
                        <div class="mb-3" id="storeDiv" style="display:none;">
                            <label>Loja(s) <small class="text-muted">(Ctrl + clique)</small></label>
                            <select class="form-select" id="newStore" multiple size="3">
                                <option>Loja A</option>
                                <option>Loja B</option>
                                <option>Loja C</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-custom w-100">Cadastrar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        let dados = JSON.parse(localStorage.getItem('dados')) || [];
        let metasMes = JSON.parse(localStorage.getItem('metasMes')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [{username: 'admin', password: 'admin123', role: 'ceo'}];
        let currentUser = null;
        let nextId = dados.length > 0 ? Math.max(...dados.map(d => d.id)) + 1 : 0;
        const todasLojas = ['Loja A', 'Loja B', 'Loja C'];

        // ATUALIZA CAMPO DE DATA
        function atualizarCampoData() {
            const periodo = document.getElementById('filtroPeriodo').value;
            const dataDiv = document.getElementById('filtroDataDiv');
            if (periodo === 'dia' || periodo === 'mes') {
                dataDiv.style.display = 'block';
                if (periodo === 'mes') {
                    document.getElementById('filtroData').type = 'month';
                } else {
                    document.getElementById('filtroData').type = 'date';
                }
            } else {
                dataDiv.style.display = 'none';
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('app').style.display = 'none';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginForm').reset();
            document.querySelectorAll('.modal').forEach(m => {
                const modal = bootstrap.Modal.getInstance(m);
                if (modal) modal.hide();
            });
        }

        function mostrarLogin() {
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('app').style.display = 'none';
        }

        function entrarNoSistema() {
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('userInfo').innerHTML = `
                Logado: ${currentUser.username} (${currentUser.role}) 
                <button class="btn btn-sm btn-danger ms-2" onclick="logout()">Sair</button>
            `;

            const adminMenu = document.getElementById('adminMenu');
            const linkTelaMetas = document.getElementById('linkTelaMetas');
            if (['ceo', 'admin', 'diretor', 'gerente'].includes(currentUser.role)) {
                adminMenu.style.display = 'block';
                linkTelaMetas.style.display = currentUser.role === 'analista' ? 'none' : 'block';
            } else {
                adminMenu.style.display = 'none';
            }

            if (['ceo', 'admin'].includes(currentUser.role)) {
                setTimeout(() => {
                    new bootstrap.Modal(document.getElementById('userModal')).show();
                }, 300);
            }

            configurarLojasUsuario();
            aplicarMetasNaTabela();
            aplicarFiltro();
        }

        function configurarLojasUsuario() {
            const lojasContainer = document.getElementById('lojasFiltros');
            lojasContainer.innerHTML = '';
            const lojasDisponiveis = currentUser.role === 'gerente' ? currentUser.stores || [] : todasLojas;

            lojasDisponiveis.forEach(loja => {
                lojasContainer.innerHTML += `<a href="#" class="nav-link" data-loja="${loja}">${loja}</a>`;
            });

            document.querySelectorAll('#lojasFiltros .nav-link').forEach(link => {
                link.addEventListener('click', e => {
                    e.preventDefault();
                    link.classList.toggle('active');
                    aplicarFiltro();
                });
            });

            ['addLoja', 'editLoja'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = lojasDisponiveis.map(l => `<option value="${l}">${l}</option>`).join('');
            });
        }

        function getDiaSemana(dateStr) {
            const dias = ['domingo', 'segunda-feira', 'terça-feira', 'quarta-feira', 'quinta-feira', 'sexta-feira', 'sábado'];
            return dias[new Date(dateStr + 'T12:00:00').getDay()];
        }

        function preencherDiaSemana() {
            const dias = ['segunda-feira','terça-feira','quarta-feira','quinta-feira','sexta-feira','sábado','domingo'];
            ['addDiaSemana', 'editDiaSemana'].forEach(id => {
                document.getElementById(id).innerHTML = dias.map(d => `<option value="${d}">${d}</option>`).join('');
            });
        }

        function aplicarMetasNaTabela() {
            dados.forEach(registro => {
                const mes = registro.data.slice(0, 7);
                const meta = metasMes.find(m => m.mes === mes && m.loja === registro.loja);
                if (meta) {
                    registro.metaBruta = meta.metaBruta;
                    registro.metaLiquida = meta.metaLiquida;
                    registro.metaGerente = meta.metaGerente || 0;
                    registro.metaDiretor = meta.metaDiretor || 0;
                    registro.metaAnalista = meta.metaAnalista || 0;
                } else {
                    registro.metaBruta = registro.metaLiquida = registro.metaGerente = registro.metaDiretor = registro.metaAnalista = 0;
                }
                registro.diferencaBruta = registro.realizadoBruta - registro.metaBruta;
                registro.diferencaLiquida = registro.realizadoLiquida - registro.metaLiquida;
                registro.ticket = registro.realizadoBruta / registro.clientes || 0;
            });
            localStorage.setItem('dados', JSON.stringify(dados));
        }

        // FILTRO CORRIGIDO
        function aplicarFiltro() {
            const periodo = document.getElementById('filtroPeriodo').value;
            const dataFiltro = document.getElementById('filtroData').value;
            const lojasAtivas = Array.from(document.querySelectorAll('#lojasFiltros .nav-link.active')).map(l => l.dataset.loja);

            let filtrados = dados.filter(row => {
                // Filtro de loja
                if (currentUser.role === 'gerente' && !currentUser.stores.includes(row.loja)) return false;
                if (currentUser.role === 'analista' && row.addedBy !== currentUser.username) return false;
                if (lojasAtivas.length > 0 && !lojasAtivas.includes(row.loja)) return false;

                // Filtro de período
                if (periodo === 'dia' && dataFiltro && row.data !== dataFiltro) return false;
                if (periodo === 'mes' && dataFiltro && row.data.slice(0, 7) !== dataFiltro.slice(0, 7)) return false;

                return true;
            });

            renderTabela(filtrados);
            renderTelaMetas(filtrados);
        }

        function renderTabela(dadosFiltrados) {
            let html = '<table class="table table-striped table-sm"><thead><tr><th>Loja</th><th>Data</th><th>Dia</th><th>Meta Bruta</th><th>Real. Bruta</th><th>Dif.</th><th>Meta Líq.</th><th>Real. Líq.</th><th>Dif.</th><th>Clientes</th><th>Ticket</th><th>Ações</th></tr></thead><tbody>';
            dadosFiltrados.forEach(row => {
                const classBruta = row.diferencaBruta < 0 ? 'below-meta' : 'above-meta';
                const classLiquida = row.diferencaLiquida < 0 ? 'below-meta' : 'above-meta';
                html += `<tr>
                    <td>${row.loja}</td>
                    <td>${row.data}</td>
                    <td>${row.diaSemana}</td>
                    <td>R$ ${row.metaBruta.toFixed(2)}</td>
                    <td class="${classBruta}">R$ ${row.realizadoBruta.toFixed(2)}</td>
                    <td>R$ ${row.diferencaBruta.toFixed(2)}</td>
                    <td>R$ ${row.metaLiquida.toFixed(2)}</td>
                    <td class="${classLiquida}">R$ ${row.realizadoLiquida.toFixed(2)}</td>
                    <td>R$ ${row.diferencaLiquida.toFixed(2)}</td>
                    <td>${row.clientes}</td>
                    <td>R$ ${row.ticket.toFixed(2)}</td>
                    <td class="action-btns">
                        <button class="btn btn-warning btn-sm" onclick="editarRegistro(${row.id})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="excluirRegistro(${row.id})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                </tr>`;
            });
            html += '</tbody></table>';
            document.getElementById('tabelaContainer').innerHTML = html;
        }

        function renderTelaMetas(dadosFiltrados) {
            const tbody = document.getElementById('telaMetasBody');
            tbody.innerHTML = '';
            dadosFiltrados.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.data}</td>
                    <td>${row.loja}</td>
                    <td>R$ ${row.realizadoBruta.toFixed(2)}</td>
                    <td>R$ ${row.metaBruta.toFixed(2)}</td>
                    <td class="${row.realizadoBruta >= row.metaBruta ? 'meta-ok' : 'meta-no'}">${row.realizadoBruta >= row.metaBruta ? 'OK' : 'Não'}</td>
                    <td>R$ ${row.realizadoLiquida.toFixed(2)}</td>
                    <td>R$ ${row.metaLiquida.toFixed(2)}</td>
                    <td class="${row.realizadoLiquida >= row.metaLiquida ? 'meta-ok' : 'meta-no'}">${row.realizadoLiquida >= row.metaLiquida ? 'OK' : 'Não'}</td>
                    <td class="${row.realizadoBruta >= row.metaGerente ? 'meta-ok' : 'meta-no'}">R$ ${row.metaGerente.toFixed(2)}</td>
                    <td class="${row.realizadoBruta >= row.metaDiretor ? 'meta-ok' : 'meta-no'}">R$ ${row.metaDiretor.toFixed(2)}</td>
                    <td class="${row.realizadoBruta >= row.metaAnalista ? 'meta-ok' : 'meta-no'}">R$ ${row.metaAnalista.toFixed(2)}</td>
                `;
                tbody.appendChild(tr);
            });
        }

        // CADASTRO DE USUÁRIO
        document.getElementById('userForm').addEventListener('submit', e => {
            e.preventDefault();
            const username = document.getElementById('newUsername').value.trim();
            if (users.some(u => u.username === username && u.role !== 'ceo')) {
                alert('Usuário já existe.');
                return;
            }
            const selectedStores = Array.from(document.getElementById('newStore').selectedOptions).map(o => o.value);
            const user = {
                username,
                password: document.getElementById('newPassword').value,
                role: document.getElementById('newRole').value,
                stores: document.getElementById('newRole').value === 'gerente' ? selectedStores : []
            };
            users.push(user);
            localStorage.setItem('users', JSON.stringify(users));
            alert('Usuário cadastrado com sucesso!');
            bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
            e.target.reset();
            document.getElementById('storeDiv').style.display = 'none';
            renderUserList();
        });

        document.getElementById('newRole').addEventListener('change', () => {
            document.getElementById('storeDiv').style.display = 
                document.getElementById('newRole').value === 'gerente' ? 'block' : 'none';
        });

        function renderUserList() {
            const tbody = document.getElementById('userListBody');
            tbody.innerHTML = '';
            users.forEach((user, idx) => {
                if (user.role === 'ceo') return;
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${user.username}</td>
                    <td>${user.role}</td>
                    <td>${user.stores ? user.stores.join(', ') : '-'}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="editarUsuario(${idx})" title="Editar">
                            <i class="bi bi-pencil"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="excluirUsuario(${idx})" title="Excluir">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.editarUsuario = function(idx) {
            const user = users[idx];
            document.getElementById('newUsername').value = user.username;
            document.getElementById('newPassword').value = '';
            document.getElementById('newRole').value = user.role;
            document.getElementById('storeDiv').style.display = user.role === 'gerente' ? 'block' : 'none';
            if (user.role === 'gerente') {
                const select = document.getElementById('newStore');
                Array.from(select.options).forEach(opt => opt.selected = user.stores.includes(opt.value));
            }
            const form = document.getElementById('userForm');
            const oldSubmit = form.onsubmit;
            form.onsubmit = e => {
                e.preventDefault();
                users[idx] = {
                    username: document.getElementById('newUsername').value,
                    password: document.getElementById('newPassword').value || user.password,
                    role: document.getElementById('newRole').value,
                    stores: document.getElementById('newRole').value === 'gerente' 
                        ? Array.from(document.getElementById('newStore').selectedOptions).map(o => o.value) 
                        : []
                };
                localStorage.setItem('users', JSON.stringify(users));
                alert('Usuário atualizado!');
                bootstrap.Modal.getInstance(document.getElementById('userModal')).hide();
                form.onsubmit = oldSubmit;
                renderUserList();
            };
            new bootstrap.Modal(document.getElementById('userModal')).show();
        };

        window.excluirUsuario = function(idx) {
            if (confirm('Excluir usuário?')) {
                users.splice(idx, 1);
                localStorage.setItem('users', JSON.stringify(users));
                renderUserList();
            }
        };

        // Eventos
        document.getElementById('loginForm').addEventListener('submit', e => {
            e.preventDefault();
            const user = users.find(u => u.username === document.getElementById('username').value && u.password === document.getElementById('password').value);
            if (user) {
                currentUser = { ...user };
                if (user.role === 'gerente') currentUser.stores = user.stores || [];
                entrarNoSistema();
            } else {
                alert('Usuário ou senha inválidos.');
            }
        });

        document.getElementById('addForm').addEventListener('submit', e => {
            e.preventDefault();
            const loja = document.getElementById('addLoja').value;
            const data = document.getElementById('addData').value;
            dados.push({
                id: nextId++,
                loja, data, diaSemana: getDiaSemana(data),
                realizadoBruta: parseFloat(document.getElementById('addRealizadoBruta').value),
                realizadoLiquida: parseFloat(document.getElementById('addRealizadoLiquida').value),
                clientes: parseInt(document.getElementById('addClientes').value),
                addedBy: currentUser.username
            });
            localStorage.setItem('dados', JSON.stringify(dados));
            aplicarMetasNaTabela();
            alert('Adicionado!');
            e.target.reset();
            aplicarFiltro();
        });

        window.editarRegistro = function(id) {
            const row = dados.find(r => r.id === id);
            document.getElementById('editId').value = id;
            document.getElementById('editLoja').value = row.loja;
            document.getElementById('editData').value = row.data;
            document.getElementById('editDiaSemana').value = row.diaSemana;
            document.getElementById('editRealizadoBruta').value = row.realizadoBruta;
            document.getElementById('editRealizadoLiquida').value = row.realizadoLiquida;
            document.getElementById('editClientes').value = row.clientes;
            document.getElementById('editForm').style.display = 'flex';
        };

        document.getElementById('editForm').addEventListener('submit', e => {
            e.preventDefault();
            const id = parseInt(document.getElementById('editId').value);
            const row = dados.find(r => r.id === id);
            row.loja = document.getElementById('editLoja').value;
            row.data = document.getElementById('editData').value;
            row.diaSemana = getDiaSemana(row.data);
            row.realizadoBruta = parseFloat(document.getElementById('editRealizadoBruta').value);
            row.realizadoLiquida = parseFloat(document.getElementById('editRealizadoLiquida').value);
            row.clientes = parseInt(document.getElementById('editClientes').value);
            aplicarMetasNaTabela();
            localStorage.setItem('dados', JSON.stringify(dados));
            document.getElementById('editForm').style.display = 'none';
            aplicarFiltro();
        });

        window.excluirRegistro = function(id) {
            if (confirm('Excluir registro?')) {
                dados = dados.filter(r => r.id !== id);
                localStorage.setItem('dados', JSON.stringify(dados));
                aplicarFiltro();
            }
        };

        document.getElementById('userListModal').addEventListener('shown.bs.modal', renderUserList);

        // Inicialização
        preencherDiaSemana();
        mostrarLogin();
        atualizarCampoData(); // Inicializa campo de data
    </script>
</body>
</html>